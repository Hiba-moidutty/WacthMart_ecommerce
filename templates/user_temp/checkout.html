{% extends 'user_temp/base.html' %}
{% load static %}

{% block content %}
<style>
    body {
        background-color: #242424;
      }
    
  </style>
<!-- Main Wrapper Start -->
<div class="wrapper bg--shaft">

<!-- navbar Start -->
<div class ="container-fluid">
    {% include 'user_temp/includes/navbar.html' %}
</div>
<!-- navbar End -->


<!-- Breadcumb area Start -->
<div class="breadcrumb-area">
  <div class="container">
      <div class="row">
          <div class="col-12 text-center">
              <h1 class="page-title">Checkout</h1>
              <ul class="breadcrumb justify-content-center">
                  <li><a href="{% url 'user_home' %}">Home</a></li>
                  <li class="current"><a href="{% url 'checkout' %}">Checkout</a></li>
              </ul>
          </div>
      </div>
  </div>
</div>
<!-- Breadcumb area End -->

<!-- Main content wrapper start -->
<div class="main-content-wrapper">
  <div class="checkout-area pt--40 pb--80 pt-md--30 pb-md--60">
      <div class="container">
          <div class="row">
              <div class="col-12">
                  <!-- User Action Start -->
                  <div class="user-actions">
                      <div class="row">
                          <div class="col-12">
                            
                              <div class="user-actions__single user-actions__coupon">
                                  <h3><i class="fa fa-cube"></i> Have A Coupon? <span class="expand_action" data-attr="#coupon_info">Click Here To Enter Your Code.</span></h3>
                                  <div id="coupon_info" class="user-actions__form user-actions--coupon hide-in-default">
                                      <form action="{% url 'apply_coupon' %}" method="POST" class="form">
                                          {% csrf_token %}
                                        <div class="form__group d-flex">
                                              <input type="text" name="coupon_code" id="coupon" class="form__input form__input--2 form__input--w285 mr--20" placeholder="Coupon Code">
                                              <input type="hidden" name="total" value="{{total}}">
                                              {% if applied %}
                                              <button onclick = removecoupon() class="btn btn-medium btn-style-3">Remove Coupon</button>
                                              {% else %}
                                              <button type="submit" class="btn btn-medium btn-style-3">Redeem</button>
                                              {% endif %}
                                        </div>
                                      </form>
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
                  <!-- User Action End -->
              </div>
          </div> 
          <div class="row">
              <div class="col-12">
                  <!-- Checkout Area Start -->
                  <div class="checkout-wrapper bg--2">
                      <div class="row">
                          <div class="col-lg-6">
                              <div class="checkout-title">
                                  <h2>BILLING ADDRESS </h2>
                              </div>
                              <div class="checkout-form">
                                  <form  method = 'POST' >
                                    {% csrf_token %}
                                      <!-- <div class="form-row mb--30">
                                          <div class="form__group col-md-6 mb-sm--30">
                                              <label for="billing_fname" class="form__label">First Name <span>*</span></label> -->
                                              <!-- <input type="text" name="billing_fname" id="billing_fname" class="form__input form__input--2"> -->
                                              <!-- {{form.first_name}} -->
                                          <!-- </div> -->
                                          <!-- <div class="form__group col-md-6"> -->
                                              <!-- <label for="billing_lname" class="form__label">Last Name <span>*</span></label> -->
                                              <!-- <input type="text" name="billing_lname" id="billing_lname" class="form__input form__input--2"> -->
                                              <!-- {{form.last_name}} -->
                                          <!-- </div> -->
                                      <!-- </div> -->
                                      <!-- <div class="form-row mb--30">
                                        <label for="billing_lname" class="form__label">Phone Number <span>*</span></label>
                                        {{form.phone_number}}
                                      </div> -->
                                      {% comment %} <div class="form-row mb--30">
                                          <div class="form__group col-12">
                                              <label for="billing_country" class="form__label">Email</label>
                                        {{form.email}}

                                          </div>
                                      </div> {% endcomment %}
                                      <div class="form-row mb--30">
                                          <div class="form__group col-12">
                                              <label for="billing_streetAddress" class="form__label">Address</label>
                                              <select id="address" class="form-select" name="address" aria-label="Default select example">
                                                <option value = "">Choose Address</option>
                                                {% for i in address %}
                                                <option value="{{i.id}}">{{i.address_1}}</option>
                                                {% endfor %}
                                              </select>
                                          </div>
                                      </div>
                                      <!-- <div class="form-row mb--30"> -->
                                          <!-- <div class="form__group col-12"> -->
                                              <!-- <label for="billing_apartment" class="form__label">Country</label> -->
                                              <!-- <input type="text" name="billing_apartment" id="billing_apartment" class="form__input form__input--2"> -->

                                          <!-- </div> -->
                                      <!-- </div> -->
                                      {% comment %} <div class="form-row mb--30">
                                          <div class="form__group col-12">
                                              <label for="billing_city" class="form__label">Order Note<span>*</span></label>
                                               <input type="text" name="ordernote"  class="form__input form__input--2"> 
                                          </div>
                                      </div> {% endcomment %}
                                      <!-- <div class="form-row mb--30">
                                          <div class="form__group col-12">
                                              <label for="billing_district" class="form__label">District <span>*</span></label>
                                          </div>
                                      </div> -->
                                      <!-- <div class="form-row mb--30">
                                          <div class="form__group col-12">
                                              <label for="billing_zip" class="form__label">Post/Zip Code <span>*</span></label>
                                              <input type="text" name="billing_zip" id="billing_zip" class="form__input form__input--2">
                                          </div>
                                      </div> -->
                                      <!-- <div class="form-row mb--30"> -->
                                          <!-- <div class="form__group col-md-6 mb-sm--30">
                                              <label for="billing_phone" class="form__label">Phone</label>
                                              <input type="text" name="billing_phone" id="billing_phone" class="form__input form__input--2">
                                          </div> -->
                                          <!-- <div class="form__group col-md-6">
                                              <label for="billing_email" class="form__label">Email Address <span>*</span></label>
                                              <input type="email" name="billing_email" id="billing_email" class="form__input form__input--2">
                                          </div> -->
                                      <!-- </div> -->
                                      <div class="form-row mb--30">
                                          <!-- <div class="form__group col-12">
                                              <div class="custom-checkbox">
                                                  <input type="checkbox" name="createaccount" id="createaccount" class="form__checkbox">
                                                  
                                                  <label for="createaccount" class="form__checkbox--label">Create An Account?</label>
                                              </div>
                                              <div class="new-account hide-in-default">
                                                  <p>Create an account by entering the information below. If you are a returning customer please login at the top of the page.</p>
                                                  <label for="newPass" class="form__label">Password <span>*</span></label>
                                                  <input type="text" name="newPass" id="newPass" class="form__input form__input--2">
                                              </div>
                                          </div> -->
                                      </div> 
                                      <div class="form-row mb--30">
                                          <div class="form__group col-12">
                                              <div class="payment-btn-group">
                                                  <!-- <inpu type="checkbox" name="shipdifferetads" id="shipdifferetads" class="form__checkbox"> -->
                                                  <a href="{% url 'add_address' %}" >
                                                  <label class="btn btn-style-3">Ship To A Different Address?</label></a>
                                              </div>
                                              <div class="ship-box-info hide-in-default mt--30">
                                                  <!-- <div class="form-row mb--30">
                                                      <div class="form__group col-md-6 mb-sm--30">
                                                          <label for="shipping_fname" class="form__label">First Name <span>*</span></label>
                                                          <input type="text" name="shipping_fname" id="shipping_fname" class="form__input form__input--2">
                                                      </div>
                                                      <div class="form__group col-md-6">
                                                          <label for="shipping_lname" class="form__label">Last Name <span>*</span></label>
                                                          <input type="text" name="shipping_lname" id="shipping_lname" class="form__input form__input--2">
                                                      </div>
                                                  </div> -->
                                                  <!-- <div class="form-row mb--30">
                                                      <div class="form__group col-12">
                                                          <label for="shipping_company" class="form__label">Company</label>
                                                          <input type="text" name="shipping_company" id="shipping_company" class="form__input form__input--2">
                                                      </div>
                                                  </div> -->
                                                  <!-- <div class="form-row mb--30">
                                                      <div class="form__group col-12">
                                                          <label for="shipping_country" class="form__label">Country</label>
                                                      </div>
                                                  </div> -->
                                                  <!-- <div class="form-row mb--30">
                                                      <div class="form__group col-12">
                                                          <label for="shipping_streetAddress" class="form__label">Street Address</label>
                                                          <input type="text" name="shipping_streetAddress" id="shipping_streetAddress" class="form__input form__input--2">
                                                      </div>
                                                  </div> -->
                                                  <!-- <div class="form-row mb--30">
                                                      <div class="form__group col-12">
                                                          <label for="shipping_apartment" class="form__label">Apartment, suite, unit etc. (optional)</label>
                                                          <input type="text" name="shipping_apartment" id="shipping_apartment" class="form__input form__input--2">
                                                      </div>
                                                  </div> -->
                                                  <!-- <div class="form-row mb--30">
                                                      <div class="form__group col-12">
                                                          <label for="shipping_city" class="form__label">Town/City <span>*</span></label>
                                                          <input type="text" name="shipping_city" id="shipping_city" class="form__input form__input--2">
                                                      </div>
                                                  </div> -->
                                                  <!-- <div class="form-row mb--30">
                                                      <div class="form__group col-12">
                                                          <label for="shipping_district" class="form__label">Districtg <span>*</span></label>
                                                      </div>
                                                  </div> -->
                                                  <!-- <div class="form-row mb--30"> -->
                                                      <!-- <div class="form__group col-12">
                                                          <label for="shipping_zip" class="form__label">Post/Zip Code <span>*</span></label>
                                                          <input type="text" name="shipping_zip" id="shipping_zip" class="form__input form__input--2">
                                                      </div> -->
                                                  <!-- </div>
                                                  <div class="form-row mb--30"> -->
                                                      <!-- <div class="form__group col-md-6 mb-sm--30">
                                                          <label for="shipping_phone" class="form__label">Phone</label>
                                                          <input type="text" name="shipping_phone" id="shipping_phone" class="form__input form__input--2">
                                                      </div> -->
                                                      <!-- <div class="form__group col-md-6">
                                                          <label for="shipping_email" class="form__label">Email Address <span>*</span></label>
                                                          <input type="email" name="shipping_email" id="shipping_email" class="form__input form__input--2">
                                                      </div> -->
                                                  </div>
                                              </div>
                                          </div>
                                      </div> 
                                      <!-- <div class="form-row">
                                          <div class="form__group col-12">
                                              <label for="orderNotes" class="form__label">Order Notes</label>
                                              <textarea class="form__input form__input--2 form__input--textarea" id="orderNotes" name="orderNotes" placeholder="Notes about your order, e.g. special notes for delivery."></textarea>
                                          </div>
                                      </div> -->
                                  
                              </div>
                          <div class="col-lg-6 mt-md--30">
                              < class="order-details">
                                  <h3 class="heading-tertiary">Your Order</h3>
                                  <div class="order-table table-content table-responsive mb--30">
                                      <table class="table">
                                          <thead>
                                              <tr>
                                                  <th>Product</th>
                                                  <th>Total</th>
                                              </tr>
                                          </thead>
                                          <tbody>
                                            {% for item in cart_items %}
                                              <tr>
                                                  <td>{{item.product.product_name}}<strong> x {{item.quantity}}</strong></td>
                                                  <td>{{item.sub_total}}</td>
                                              </tr>
                                            {% endfor %}
                                          </tbody>
                                          <tfoot>
                                              <tr class="cart-subtotal">
                                                  <th>Cart Subtotal</th>
                                                  <td>₹{{total}}</td>
                                              </tr>
                                              <tr class="shipping">
                                                  <th>Tax Included</th>
                                                  <td>₹{{tax}}
                                                  </td>
                                              </tr>
                                              <tr class="cart-subtotal">
                                                <th>Coupon Added</th>
                                                <td>₹{{grand_total}}</td>
                                            </tr>
                                              <tr class="order-total">
                                                  <th>Order Total</th>
                                                  <td><span class="order-total-ammount">₹{{grand_total}}</span></td>
                                              </tr>
                                          </tfoot>
                                      </table>
                                  </div>
                                  <div class="checkout-payment">
                                      <!-- <form action="#" class="payment-form"> -->
                                          <div class="payment-btn-group d-grid">
                                                <button type="button" name="submit"  onclick = "cod()"  class="btn btn-info "><strong>Cash on Delivery</strong></button>
                                          </div>
                                          <br>
                                          <div class="payment-group">
                                              <div>
                                                {% comment %} <h6>Pay via Paypal</h6> {% endcomment %}
                                                <div id="paypal-button-container"></div>
                                              </div> 
                                          </div>
                                          <div class="payment-group">
                                            {% comment %} <h6>Pay via Razorpay</h6> {% endcomment %}
                                            <div class="btn btn-warning d-grid">
                                              <div id="rzp-button1"><strong>Razorpay</strong></div>
                                            </div> 
                                        </div>
                                          <div class="payment-btn-group">
                                              <a href="{% url 'store' %}"  class="btn btn-style-3" >Continue Shopping</a>
                                          </div>
                                      <!-- </form> -->
                                  </div>
                              </div>
                          </div>
                      </div>
                  </div>
                  <!-- Checkout Area End -->
              </div>
          </div>
        </form>
      </div>     
  </div>
</div>
<!-- Main content wrapper end -->

   <!-- Footer Start  -->
  
    {% include 'user_temp/includes/footer.html'%}
 

    <!-- Scroll To Top Start -->    
    <a class="scroll-to-top" href="#"><i class="fa fa-angle-double-up"></i></a>
    <!-- Scroll To Top End -->
  

<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script defer src="https://cdn.crop.guide/loader/l.js?c=FWCZMT"></script>
<script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
<script src="https://unpkg.com/sweetalert/dist/sweetalert.min.js"></script>
{% comment %} <link href="//cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css" rel="stylesheet">
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script> {% endcomment %}
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<script src="https://www.paypal.com/sdk/js?client-id=AZ54SF_9XhjbZoC2GRn4bZUwGSJmxPhMlHREiWidNqm9zMfdFLRW4LCvxjAoXx1FMusHTxTKGolAyCaP&currency=USD"></script>
<script src="https://checkout.razorpay.com/v1/checkout.js"></script>

<link href="//cdn.jsdelivr.net/npm/@sweetalert2/theme-dark@4/dark.css" rel="stylesheet">
<script src="//cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.js"></script>


<script>
    function cod(){
        event.preventDefault()
        var address = document.getElementById('address').value
        console.log(address)
        var token = $('input[name = csrfmiddlewaretoken]').val();

        data = {
            'i_id' : address,
            "p_method" : "cash on delivery",
            "csrfmiddlewaretoken" : token
        }
        console.log()

        if (address == ""){
            console.log('hhhhhhhhhhhhhhhhhhhhhhhhhhhhh')
            Swal.fire(
                'All fields are required!',
                ' !!',
                'error'
              )
            return false;
        }
        
        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes!'
          }).then((result) => {
            if (result.isConfirmed) {
                $.ajax({
                    method :"POST",
                    url : "{% url 'place_order' %}",
                    data : data,
                    success : function(response){
                        window.location = "{% url 'order_success' %}"
                    }
                });
            }
        })
    }

</script>


{% comment %} for integrating Razorpay {% endcomment %}
 <script>
    var options = {
        "key": "rzp_test_ow6sQKwWcM8BIK", // Enter the Key ID generated from the Dashboard
        "amount":"{{grand_total}}"*100, // Amount is in currency subunits. Default currency is INR. Hence, 50000 refers to 50000 paise
        "currency": "INR",
        "name": "Acme Corp",
        "description": "Test Transaction",
        "image": "https://example.com/your_logo",
        //"order_id": "{{order_id}}" ,  //This is a sample Order ID. Pass the `id` obtained in the response of Step 1
        "handler": function (response){
          var address=document.getElementById('address').value;
          if (address == undefined){
              
              swal.fire("Alert", "All Fields are required", "error");
              return false;
          }
      
                  
          $.ajax( {
              type: "POST",
              url: "{% url 'place_order' %}",
              data: {
                  coupon :  $("#ccode").val(),
                  p_method : 'razorpay',
                  i_id: address,
                  //payment_id :  orderData.id,
                  //order_id :response.razorpay_order_id,
                  signature:response.razorpay_signature,
                  csrfmiddlewaretoken: '{{ csrf_token }}',
                  dataType: "json",
              },
              success: (response) => {
                  console.log("success"),
                  
                  window.location="{% url 'order_success' %}" 
                  
              },error: function() {
                  alert('Error occured 101');
              }
          
          })

        },
        "prefill": {
            "name": "User",
            "email": "user@example.com",
            "contact": "9544633437"
        },
        "notes": {
            "address": "Razorpay Corporate Office"
        },
        "theme": {
            "color": "#3399cc"
        }
    };
    var rzp1 = new Razorpay(options);
    rzp1.on('payment.failed', function (response){
          //   alert(response.error.code);
          //   alert(response.error.description);
          //   alert(response.error.source);
          //   alert(response.error.step);
          //   alert(response.error.reason);
          //   alert(response.error.metadata.order_id);
          //   alert(response.error.metadata.payment_id);
          swal("Payment failed", "Order pending", "error").then(function () { window.location.reload() })
    });
    document.getElementById('rzp-button1').onclick = function(e){
        rzp1.open();
        e.preventDefault();
    }
</script>


    {% comment %} for integrating Paypal {% endcomment %}
    <script>
        paypal.Buttons({

            onClick:(data,actions)=>{
                var address = document.getElementById('address').value
                var token=$('input[name=csrfmiddlewaretoken]').val();
                console.log(address)
                if(address == ""){
                    Swal.fire(
                    'All fields are required!',
                    '!!',
                    'error'
                    )
                    return false;
                }
                else{
                    return true;
                }
            },

          // Sets up the transaction when a payment button is clicked
          createOrder: (data, actions) => {
            return actions.order.create({
              purchase_units: [{
                amount: {
                  value: '{{grand_total}}' // Can also reference a variable or function
                }
              }]
            });
          },
          // Finalize the transaction after payer approval
          onApprove: (data, actions) => {
            return actions.order.capture().then(function(orderData) {
              // Successful capture! For dev/demo purposes:
              console.log('Capture result', orderData, JSON.stringify(orderData, null, 2));
              const transaction = orderData.purchase_units[0].payments.captures[0];
              alert(`Transaction ${transaction.status}: ${transaction.id}\n\nSee console for all available details`);
              // When ready to go live, remove the alert and show a success message within this page. For example:
              // const element = document.getElementById('paypal-button-container');
              // element.innerHTML = '<h3>Thank you for your payment!</h3>';
              // Or go to another URL:  actions.redirect('thank_you.html');
              var address = document.getElementById('address').value
              var token=$('input[name=csrfmiddlewaretoken]').val();
              data={
                'i_id':address,
                "p_method":"Paypal",
                'payment_id': orderData.id,
                'csrfmiddlewaretoken':token,
            }
            console.log('enteringgggggggggggg')
            $.ajax({
                method: "POST",
                url: "{% url 'place_order' %}",
                data: data,
                success: function (response) {
                  
                      window.location="{% url 'order_success' %}" 
                   
                    
                }
            });
            console.log(data)
          });
        }
        
    }).render('#paypal-button-container');

    </script>
    

    <script>
        function removecoupon(){
            event.preventDefault()

            Swal.fire({
                title : 'Are you sure you want to remove coupon?',
                text:'You can reuse after removing the coupon!',
                icon:'warning',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor:'#d33',
                confirmButtonText:'Yes'
            }).then((result)=>{
                if(result.isConfirmed){
                    $.ajax({
                        method:"GET",
                        url:"{% url 'delete_coupon' %}",
                        data:{'1':1},
                        success: function(response){
                            window.location="{% url 'checkout' %}"                            
                        }
                    });
                }
            })
        }

    </script>

{% endblock %}